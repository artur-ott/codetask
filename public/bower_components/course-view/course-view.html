<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../koan-task/koan-task.html">
<link rel="import" href="../video-task/video-task.html">
<link rel="import" href="../code-task/code-task.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="course-view">
  <template>
    <!-- data -->
    <iron-ajax
      auto
      url="/api/courses/{{courseId}}"
      handle-as="json"
      on-response="courseLoaded">
    </iron-ajax>

    <iron-ajax
      auto
      url="/api/solutions/{{courseId}}"
      handle-as="json"
      on-response="solutionsLoaded">
    </iron-ajax>

    <div class="row">
      <div id="navigation" class="col-md-3 center"></div>
      <div id="main" class="col-md-8"></div>
    </div>
  </template>

  <style>
    #main {
      padding: 10px;
      padding-top: 10px;
    }
    #navigation {
      padding-top: 30px;
      margin-left: 10px;
      margin-right: 20px;
    }
  </style>

  <script>
    Polymer({
      is: "course-view",
      properties: {
        courseId: Number
      },

      created: function() {
        this.loaded_ = {};
      },

      courseLoaded: function(e, request) {
        var course = request.xhr.response;
        this.loaded_.course = course;
        if (this.loaded_.solutions)
          this.initialize(course, this.loaded_.solutions);
        if (e) console.log(e);
      },

      solutionsLoaded: function(e, request) {
        var solutions = request.xhr.response;
        this.loaded_.solutions = solutions;
        if (this.loaded_.course)
          this.initialize(this.loaded_.course, solutions);
        if (e) console.log(e);
      },

      initialize: function(course, solutions) {
        var this_ = this;
        // build navigation
        var ol = $('<div></div>').addClass('list-group');
        course.chapters.forEach(function(chapter, index) {
          var solution = solutions.find(function(solution) {
            return solution.chapterId == chapter.id;
          });

          var li = $('<li></li>')
            .addClass('list-group-item')
            .html(chapter.title)
            .click(function() {
              var solution = solutions.find(function(solution) {
                return solution.chapterId == course.chapters[0].id;
              });
              this_.loadChapter(chapter, solution);
            });

          var checked = 0;
          var keys = [];

          // count checked tasks
          if (solution && solution.tasksStates) {
            solution.taskStates.forEach(function(state) {
              if (state.checked) checked += 1;
            });
          }
          var badge = $('<span></span>').addClass('badge').text(checked + '/' + Object.keys(chapter.tasks).length);
          li.append(badge);
          if (index == 0) {
            li.addClass('active');
            this_.badge_ = badge;
          } else {
            li.click(function() {
              this_.loadChapter(course.chapters[index], solution, course.id);
            });
          }
          li.appendTo(ol);
        });
        $('#navigation').append(ol)

        var solution = solutions.find(function(solution) {
          return solution.chapterId == course.chapters[0].id;
        });
        this.loadChapter(course.chapters[0], solution, course.id)
      },

      loadChapter: function(chapter, solution, courseId) {
        var main = document.getElementById("main");
        // clear previous chapter
        $(main).children().attr('visible', false);

        var h1 = document.createElement("H1");
        h1.textContent = chapter.title;
        main.appendChild(h1);


        var elements = [];

        chapter.tasks.forEach(function(task) {
          var taskSolution = solution.taskStates.find(function(state) {
            return state.taskId == task.id;
          });
          var element = document.createElement(task.tag);
          element.id = task.id;

          Object.keys(task.data).forEach(function(key) {
            element[key] = task.data[key];
          });
          if (taskSolution) {
            Object.keys(taskSolution.state).forEach(function(key) {
              element[key] = taskSolution.state[key];
            });
          }
          
          element.interpreterUrl = '/testInterpret';
          main.appendChild(element);
          elements.push(element);
        });

        // initialize hook
        var this_ = this;

        var updateBadges = function() {
          // set checked count of nav badge
          var checked = elements.reduce(function(amount, el) {
            return el.checked ? amount + 1 : amount;
          }, 0);
          this_.badge_.text(checked + '/' + elements.length);
        };

        var saveState = function(options) {
          return function() {
            var chapterState = {
              courseId: courseId,
              chapterId: chapter.id,
              taskStates: []
            };

            elements.forEach(function(element) {
              chapterState.taskStates.push({
                taskId: element.id,
                state: element.state
              });
            });
            console.log(chapterState);
            $.ajax({
              type: 'POST',
              url: '/api/solutions/' + courseId,
              data: JSON.stringify(chapterState),
              contentType: 'application/json; charset=utf-8',
              dataType: 'json',
              async: options.async,
              success: function(data, status, xhr) {
                if (status == 'success')
                  console.log('state saved');
              },
              error: function(xhr, status, y) {
                //console.log('could not save state');
                console.log(status);
                console.dir(chapterState)
              }
            });
          };
        };

        if (!this.initialized_) {
          this.initialized_ = true;
          setInterval(updateBadges, 1000);
          setInterval(saveState({async: true}), 30000);
          window.onbeforeunload = function(){
             saveState({async: false})();
             console.log('saved0');
             return null;
          };
        }
      },
    });
  </script>
</dom-module>