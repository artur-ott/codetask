<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ace-import/ace-import.html">
<link rel="import" href="../abstract-task/abstract-task.html">

<dom-module id="code-task">
	<style>
		.code-task-editor {
		    /*border: 5px solid #01313f;*/
			display: inline-block;
		}
		.code-task-output {
			overflow: auto;
			padding-top: 1px;
			color: #93a09f;
			font-family: "Lucida Console", Monaco, monospace;
			background-color: #01313f;
		}
		.code-task-editor, .code-task-output {
			display: inline-block;
			height: 300px;
			width: 50%;
			border: 0px;
			border-radius: 0px;
			margin-bottom: -4px;
		}
		.code-task-button {
			font-size: 100%;
			width: 100%;
			height: 30px;
			color: white;
			text-align: center;
			vertical-align: text-top;
			background-color: #097C2C;
			border: 0px;
			border-bottom-left-radius: 25px;
			border-bottom-right-radius: 25px;
		}
		.code-task-button:hover {
			cursor: pointer;
			opacity: 0.4;
    		filter: alpha(opacity=40);
		}
	</style>

	<script>
		Polymer({
			is: 'code-task',
			extends: 'abstract-task',

			// instance state
			created: function() {
				this.code_ = '';
				this.mode_ = 'scala';
				this.theme_ = 'solarized_dark';
				this.interpreterUrl_ = '';
				this.postUrl_ = '';
			},

			get code() { return this.code_; },
			set code(value) { this.code_ = value; },
			get mode() { return this.mode_; },
			set mode(value) { this.mode_ = value; },
			get theme() { return this.theme_; },
			set theme(value) { this.theme_ = value; },
			get interpreterUrl() { return this.interpreterUrl_; },
			set interpreterUrl(value) { this.interpreterUrl_ = value; },
			get postUrl() { return this.postUrl_; },
			set postUrl(value) { this.postUrl_ = value; },
			get aceEditor() { return this.aceEditor_; },
			set aceEditor(value) { this.aceEditor_ = value; },
			get output() { return this.output_; },
			set output(value) { this.output_ = value; },

			attached: function() {
				this.addDescription();

				// create children
				var editor = $('<pre></pre>')
					.addClass('code-task-editor')
					.attr('id', this.id + '-editor')
					.appendTo(this);

				var output = $('<pre></pre>')
					.addClass('code-task-output')
					.attr('id', this.id + '-output')
					.appendTo(this);

				var button = $('<button>Run</button>')
					.addClass('code-task-button')
					.attr('id', this.id + '-button')
					.appendTo(this);

				// setupt ace editor
				this.aceEditor_ = ace.edit(editor.attr('id'));
				this.aceEditor.setTheme('ace/theme/' + this.theme);
				this.aceEditor.session.setMode('ace/mode/' + this.mode);
				this.aceEditor.setOptions({fontSize: '11pt'});
				this.aceEditor.setValue(this.code);

				// setup console
				this.output = output;

				// setup button
				var this_ = this;
				button.click(function() { this_.run(); });

				// check
				this.check(this.checked);
			},
			post: function() {
				var this_ = this;

				$.ajax({
					type: 'POST',
					url: this.postUrl,
					data: JSON.stringify({ code: this.code }),
					contentType: 'application/json; charset=utf-8',
					dataType: 'json',
					success: function(data, status, xhr) {
						console.log(this_.id + ' saved');
					},
					error: function(xhr, status) {
						console.log('could not save data of ' + 
							this_.id + ' status: ' + status);
					}
				});
			},
			run: function() {
				var this_ = this;

				$.ajax({
					type: 'POST',
					url: this.interpreterUrl,
					data: JSON.stringify({ code: this.code }),
					contentType: 'application/json; charset=utf-8',
					dataType: 'json',
					success: function(data, status, xhr) {
						if (status == 'success')
							this_.output.text(data.output);
						else
							this_.output.text(data.error);
					},
					error: function(xhr, status) {
						console.log('could not save data of ' + 
							this_.id + ' status: ' + status);
					}
				});
			}
		});
	</script>
</dom-module>