<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../jquery-import/jquery-import.html">
<link rel="import" href="../abstract-task/abstract-task.html">

<script src="https://www.youtube.com/iframe_api"></script>

<dom-module id="video-task.html">
	<script>
		Polymer({
			is: 'video-task',
			extends: 'abstract-task',
			properties: {
				url: String,
		    	postUrl: String,
		    	state: {
		    		type: Number,
		    		value: 2
		    	}
		    },
			attached: function() {
				var video = this;

				video.addDescription();
				if (video.state == 0) video.check();

			   	// add youtube player div
				var div = document.createElement('div');
				div.id = video.id + '-player';
				video.appendChild(div);


				// get video code
				var url = video.url.split('?v=');

				player = new YT.Player(div.id, {
			        height: '300px',
			        width: '100%',
			        videoId: (url.size > 1 ? url[url.size - 1] : url),
			        events: {
			            'onStateChange': function(event) {
			            	// playing: 1, stopped: 2, ended: 0
			            	if (event.data == 0) {
			            		video.state = 0;
			            		video.check();
			            	}
			            }
			        }
		    	});
			},
			post: function() {
				$.ajax({
					type: 'POST',
					url: this.postUrl,
					data: JSON.stringify({ state: this.state }),
					contentType: 'application/json; charset=utf-8',
					dataType: 'json',
					success: function(data, status, xhr) {
						console.log(this.id + ' saved');
					},
					error: function(xhr, status) {
						console.log('could not save data of ' + 
							this.id + ' status: ' + status);
					}
				});
			}
		});
	</script>
</dom-module>