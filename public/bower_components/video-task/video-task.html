<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../jquery-import/jquery-import.html">
<link rel="import" href="../abstract-task/abstract-task.html">

<script src="https://www.youtube.com/iframe_api"></script>

<dom-module id="video-task.html">
	<script>
		Polymer({
			is: 'video-task',
			extends: 'abstract-task',
			
			// instance state
			created: function() {
				this.watched_ = false;
			},

			get url() { return this.url_; },
			set url(value) { this.url_ = value; },
			get postUrl() { return this.postUrl_; },
			set postUrl(value) { this.postUrl_ = value; },
			get watched() { return this.watched_; },
			set watched(value) { this.watched_ = value; },

			attached: function() {
				this.addDescription();
				
				if (this.watched) this.check(true);

			   	// add youtube player div
			   	var id = this.id + '-player';
			   	$('<div></div>').attr('id', id).appendTo(this);

				// get video code
				var url = this.url.split('?v=');
				var this_ = this;
				player = new YT.Player(id, {
			        height: '300px',
			        width: '100%',
			        videoId: (url.size > 1 ? url[url.size - 1] : url),
			        events: {
			            'onStateChange': function(event) {
			            	// playing: 1, stopped: 2, ended: 0
			            	if (event.data == 0) {
			            		this_.watched = true;
			            		this_.check(true);
			            	}
			            }
			        }
		    	});
			},
			post: function() {
				$.ajax({
					type: 'POST',
					url: this.postUrl,
					data: JSON.stringify({ watched: this.watched }),
					contentType: 'application/json; charset=utf-8',
					dataType: 'json',
					success: function(data, status, xhr) {
						console.log(this.id + ' saved');
					},
					error: function(xhr, status) {
						console.log('could not save data of ' + 
							this.id + ' status: ' + status);
					}
				});
			}
		});
	</script>
</dom-module>