<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/koan-task/koan-task.html">
<link rel="import" href="../bower_components/video-task/video-task.html">
<link rel="import" href="../bower_components/code-task/code-task.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="course-view">
	<template>
		<!-- data -->
		<iron-ajax
			auto
			url="/course/json/{{courseName}}"
			handle-as="json"
			last-response="{{response1}}"
			on-response="courseLoaded">
		</iron-ajax>

		<iron-ajax
			auto
			url="/solutions/json/{{courseName}}"
			handle-as="json"
			last-response="{{response2}}">
		</iron-ajax>

		<div class="row">
			<div id="navigation" class="col-md-2"></div>
			<div id="main" class="col-md-10"></div>
		</div>
	</template>

	<style>
		#main {
			padding: 70px;
			padding-top: 10px;
		}
	</style>

	<script>
		Polymer({
			is: "course-view",
			properties: {
		    	courseName: String
		    },
		    ready: function() {

		    },
		    courseLoaded: function(e, request) {
		    	var course = request.xhr.response.course;
		    	this.loadChapter(course.chapters[0]);
		    },
		    loadChapter: function(chapter) {
		    	var main = document.getElementById("main");
		    	// clear previous chapter
		    	while(main.firstChild) {
		    		main.removeChild(tasks.firstChild);
		    	}

		    	var h1 = document.createElement("H1");
		    	h1.textContent = chapter.title;
		    	main.appendChild(h1);

		    	var tasks = chapter.tasks;
		    	var aceTheme = "solarized_dark";

		    	Object.keys(tasks).forEach(function(key) {
		    		var task = tasks[key];

		    	 	if (key.indexOf("video") != -1) {

		    	 		var video = document.createElement("video-task");
		    	 		video.id = key;
		    	 		video.description = task.description;
		    			video.url = task.url;
		    			video.postUrl = '/solution';
		    			//video.state = 0;
		    	 		main.appendChild(video);

		    		} else if (key.indexOf("koan") != -1) {

		    			var koan = document.createElement("koan-task");
		    			koan.id = key;
		    			koan.description = task.description;
		    			koan.theme = aceTheme;
		    			koan.mode = 'scala';
		    			koan.code = task.code;
		    			koan.solutions = task.solutions;
		    			koan.postUrl = '/solution';
		    			main.appendChild(koan);

		    		} else if (key.indexOf("codetask") != -1) {

		    			var editor = document.createElement("code-task");
		    			editor.id = key;
		    			editor.description = task.description;
		    			editor.interpreterUrl = '/solution';
		    			editor.postUrl = '/solution';
		    			editor.theme = aceTheme;
		    			editor.mode = 'scala';
		    			editor.code = task.code;
		    			main.appendChild(editor);
		    		}
		    	});
		    },
		    processTasks: function(tasks) {
		    	var keys = Object.keys(tasks);
		    	return keys.map(function(key) {
		    		return {name: key, task: tasks[key]};
		    	});
		    }
		});

		function addDescription(element, description) {
	    	var p = document.createElement("P");
	    	p.innerHTML = description;
	    	element.appendChild(p);
	    }
	</script>
</dom-module>